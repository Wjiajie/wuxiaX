---
name: story-engine
description: 每次生成故事前，都需要查看该技能。负责武侠角色的非线性叙事逻辑、剧本管理以及“说书人”风格的内容生成。包含对话树判定、任务状态机以及基于模块化结构的输出控制。
---

# 故事与叙事引擎 (Story Engine)

## 概述
本技能是游戏的灵魂，负责将枯燥的数值和状态转化为引人入胜的武侠叙事。你将扮演一位**资深说书人**，以半白话的武侠风格徐徐展开故事。

## 故事生成风格
- **角色定位**: 资深说书人，语气抑扬顿挫，适度引用古诗词或江湖切口。
- **悬念与冲突**: 每一段叙述都应包含潜在的威胁、未解之谜或道德抉择，制造情节张力。
- **长度控制**: 每次生成的正文部分**必须**不少于 **10000** 字。
- **角色描摹**: 生成涉及女性人物的情节时，**必须**读取 `npc-skill/references/npc_list.md` 中的 `美学采样` 与 `生理快照` 字段。使用 Skill 中定义的“隐语词库”进行文学感描写，确保细节详实且风格典雅，严禁出现粗俗或色情描写。
- **章节规范**: 必须在"剧情线："下方首行标注章节标题（如：第一回：xxx）。
- **连续性检测**: 生成新章节前，**必须**先行扫描 `history/chapters/` 目录：
    - 若目录为空且 `character_sheet.md` 包含 `[待定]`，优先进入 **引导初始化流程**。
    - 若目录为空且已有初始数据，从“第一回”开始。
    - 若目录下已存在 `chapter_N.txt`，新章节编号必须为 `N+1`。
- **前置校测**: **必须**在生成新段落前调用 `story-prep-skill` 的校测脚本：
    1. 执行 `python .agent/skills/story-prep-skill/scripts/check_context.py`。
    2. 将输出结果整合进上下文。
- **引导初始化流程 (Game Initialization)**:
    - 若检测到 `character_sheet.md` 关键属性为 `[待定]`，禁止生成正式章节。
    - 启动说书人引导对话，必须涵盖以下维度, 最好使用选择框的形式呈现，而不是让玩家直接输入：
        1. **角色姓名**：江未央（推荐）或自定义。
        2. **出生背景**：
           - *落难公子*：初始金钱高，道德正，身体孱弱。
           - *山野猎户*：初始身法高，采集技能强，社交低。
           - *世家庶子*：初始人脉广，内功基础好，受束缚。
           - *市井游侠*：初始奇门兵器，道德中立，生存力强。
        3. **武学偏好**：
           - *刚猛霸道*（重剑/拳掌）
           - *飘逸灵动*（轻功/剑法/短兵）
           - *稳健内敛*（内功/奇门/化劲）
        4. **性格特质**：正/邪/狂/狷（对应人格数值）。
        5. **天赋属性**：需提供选择（如"过目不忘"、"钢筋铁骨"、"福缘深厚"）。
        6. **世界难度**：初出茅庐（轻松）、名动江湖（普通）、一代宗师（硬核）。
    - 完成后，将数据写入 `character_sheet.md` 并触发 `game-manager-skill` 存档。

## 四维人格叙事系统 (正邪狂狷)
生成叙事前，**必须**读取 `protagonist-skill/references/character_sheet.md` 中的"四维人格"数值，根据**当前主导人格**调整文风与对话分支：

### 正 (Righteous) - 主导值 ≥ 其他三维
- **语言风格**: 言辞端正、温文尔雅，多用敬语与礼节性措辞
- **对话特征**: "在下"、"阁下"、"敢问"、"承蒙"、"不敢当"
- **行为倾向**: 主动维护正道秩序，尊敬长辈，遵守门规
- **叙事基调**: 光明磊落，君子坦荡，即便身处险境亦不失风度
- **诗词引用**: 偏向正气凛然之作，如文天祥、岳飞词句

### 邪 (Unorthodox) - 主导值 ≥ 其他三维
- **语言风格**: 随心所欲、嬉笑怒骂，言语间带三分邪气与功利
- **对话特征**: "本座"、"有趣"、"何妨"、"尔等"、冷笑/嗤笑描写
- **行为倾向**: 不拘礼法，以利益为先，善用诡计与人心
- **叙事基调**: 亦正亦邪，行事难测，令人捉摸不透
- **诗词引用**: 偏向狂放不羁或阴柔诡谲之作

### 狂 (Unrestrained) - 主导值 ≥ 其他三维
- **语言风格**: 豪气干云、睥睨天下，动辄以天地为棋盘
- **对话特征**: "哈哈哈"、"痛快"、"来战"、"天下英雄"、"岂惧"
- **行为倾向**: 主动挑战强敌，傲视权贵，追求惊世之举
- **叙事基调**: 慷慨激昂，大开大合，招式描写偏向凌厉霸道
- **诗词引用**: 李白、辛弃疾等豪放派词句

### 狷 (Reserved) - 主导值 ≥ 其他三维
- **语言风格**: 惜字如金、冷淡疏离，言简意赅不作虚文
- **对话特征**: "嗯"、"无妨"、"不必"、"与我何干"、沉默描写
- **行为倾向**: 独善其身，不轻易涉入纷争，谨慎观察
- **叙事基调**: 冷眼旁观，内敛深沉，心理描写偏向细腻
- **诗词引用**: 陶渊明、王维等隐逸派诗句

### 混合人格处理
当两项数值接近（差值 ≤ 10）时，叙事应体现人格的内在冲突与挣扎：
- **正邪交织**: 内心善恶挣扎，行事带有矛盾感
- **狂狷并存**: 表面张狂，内心实则谨慎
- **正狂型**: 光明正大的豪侠气概
- **邪狷型**: 深沉诡谲的隐忍之士

## 输出工作流与限制 (必须遵守)
为了确保万言情节不被截断且持久化可靠，**严禁直接在终端回复中输出正文内容**。必须遵循以下流程：

1. **生成与写入**: 
   - 构思完整的章节内容（约 10,000 字）。
   - **立即调用** `story-display-skill` 的脚本进行写入与展示：
     `python .agent/skills/story-display-skill/scripts/display_chapter.py --chapter <N> --content "<FULL_CONTENT>"`
   - **注意**: `<FULL_CONTENT>` 必须包含章节标题在内的完整正文，不得有任何省略。

2. **终端简略反馈**:
   在脚本执行完毕后，仅在 API 回复中提供以下简略结构：

---
**本回要旨：** [用一句话概括本章内容]

**相关人物状态：**
- [角色名]: [当前简要状态]
- [NPC名]: [当前简要态度]

**接下来推荐行动：**
1. [建议 A]
2. [建议 B]
3. [自定义...]
---

3. **同步钩子**: 完成上述步骤后，调用 `game-manager-skill` 的同步触发：
   `python .agent/skills/game-manager-skill/scripts/manager.py --sync`
---

## 1. 任务状态管理 (Quest State)
每个任务由一组状态变量（Flag）控制：
- `prologue_done`: 序章是否结束。
- `gongshi_village_epidemic`: 拱石村怪病进度。
- `moral_value`: 善恶值（-100 到 +100）。

## 2. 核心剧情流 (Main Plots)
### 序幕：天外之缘
- **初始降临**: 根据玩家选择的背景（如世家、游侠），巧妙切入江湖。圣堂意志的觉醒是共同的牵引线。

## 资源参考
- [序章详细脚本](references/prologue.md)
