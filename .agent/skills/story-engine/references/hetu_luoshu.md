# 河图洛书碎片追踪系统 (Hetu Luoshu Fragment Tracking)

## 概述
> *昔者伏羲氏王天下也，仰则观象于天，俯则观法于地，观鸟兽之文与地之宜，近取诸身，远取诸物，于是始作八卦，以通神明之德，以类万物之情。*

河图洛书乃上古至宝，蕴含天地至理。碎片散落江湖各处，集齐者可窥天机、悟大道。

## 碎片获取判定逻辑

### 1. 前置条件检查
```
function canObtainFragment(fragmentId, protagonist):
    fragment = getFragment(fragmentId)

    # 检查位置
    if protagonist.location != fragment.location:
        return False, "尚未抵达碎片所在之处"

    # 检查特定条件
    match fragmentId:
        case "河图·乾位残片":
            return True # 初始可能携带或在特定地点获得
        case "河图·坤位残片":
            return protagonist.questCompleted("石家任务线")
        case "河图·坎位残片":
            return protagonist.waterSkill >= 30 or protagonist.hasItem("避水珠")
        case "河图·离位残片":
            return protagonist.hasFireResist or protagonist.innerPower >= 25
        case "洛书·天枢碎片":
            return protagonist.factionRelation("木府") >= "友善"
        case "洛书·天璇碎片":
            return protagonist.hasColdResist and protagonist.lightness >= 20
        case "洛书·天玑碎片":
            return protagonist.hasItem("避毒珠")
        case "洛书·天权碎片":
            return protagonist.fragmentCount >= 3 and protagonist.personalitySum >= 150
```

### 2. 碎片感应机制
当主角持有【河图·乾位残片】时，可感应其他碎片方位：
- **感应范围**：当前区域 + 相邻区域
- **感应描述**：根据距离远近，描述从"隐隐有所感应"到"灵光大盛，指引明确"

### 3. 碎片收集状态追踪
```yaml
fragment_status:
  河图·乾位残片: false
  河图·坤位残片: false
  河图·坎位残片: false
  河图·离位残片: false
  洛书·天枢碎片: false
  洛书·天璇碎片: false
  洛书·天玑碎片: false
  洛书·天权碎片: false

collection_count: 0
active_buffs: []
next_clue: "根据当前位置与背景探索初始线索"
```

## 碎片获取叙事模板

### 通用发现描述
> 忽觉怀中一阵温热，那{已有碎片名}竟自行震颤起来，仿佛在回应着什么。循着那若有若无的牵引，{主角名}的目光落在了{发现位置}......

### 各碎片专属叙事

#### 河图·乾位残片
> 石壁之上，金光隐现。那光芒并非来自外界，而是自石中透出，仿佛有什么沉睡万年之物正在苏醒。{主角名}伸手触碰，只觉一股浩然之气自指尖涌入，直冲百脉......
>
> 待那金光散去，石壁已然裂开一道缝隙，一枚古朴玉片静静躺在其中，其上篆刻着繁复纹路，细观之下，竟是星辰运转之象。

#### 河图·坤位残片
> 石家庄密室深处，一座不起眼的石台上，摆放着一枚满是尘埃的玉片。{主角名}拂去浮尘，入手温润，隐隐有大地脉动之感。这便是传说中承载地道的【坤位残片】......

#### 河图·坎位残片
> 海底洞窟幽深，水光粼粼间，{主角名}瞥见一抹异彩。那是一枚玉片，静静悬浮于水中，周遭海水竟形成漩涡护持。伸手取来，冰凉入骨，却有生生不息之意蕴含其中......

#### 河图·离位残片
> 火山口热浪滚滚，寻常人等早已难以承受。{主角名}咬牙前行，忽见岩浆中央一块突兀黑石，其上一枚玉片正散发着炽热光芒。那光芒不似火焰灼热，反有一种温和的力量......

#### 洛书·天枢碎片
> 木府密室藏书万卷，{主角名}在某册泛黄古籍中发现一枚薄薄玉片。取出细观，竟有星图隐现，正是北斗七星之首——天枢。一时间，脑海中无数武学要义如走马灯般闪过......

#### 洛书·天璇碎片
> 冰峰之巅，寒风凛冽。一座冰晶石台上，一枚玉片半嵌其中，散发着幽蓝光芒。{主角名}以内力护体，缓缓将其取出，只觉周身经脉为之一震，内力竟似有扩充之兆......

#### 洛书·天玑碎片
> 毒瘴深处，万籁俱寂。一株奇异的七彩毒花根部，半掩着一枚古玉。{主角名}小心取来，那玉片入手竟有温凉之感，似能中和百毒......

#### 洛书·天权碎片（终极碎片）
> 当第三枚碎片入手的刹那，三片古玉同时震颤，投射出一道虚幻光芒。光芒所指之处，竟是......{隐藏地点}！
>
> 历经艰险，{主角名}终于来到那神秘所在。空中悬浮着最后一枚碎片，周遭八卦阵图缓缓流转。将四枚碎片置于阵眼，{主角名}只觉天旋地转，仿佛窥见了天地初开的景象......

## 碎片效果叠加规则

### 被动效果激活
| 收集数量 | 激活效果 | 叙事描述 |
|----------|----------|----------|
| 2片 | 【灵犀一点】 | 周遭隐藏之物，皆有微光闪烁，逃不过{主角名}的眼睛 |
| 4片 | 【天人感应】 | 战斗之际，敌人出招的瞬间，{主角名}竟能隐约预知其轨迹 |
| 6片 | 【洞悉天机】 | 与人交谈时，对方的真实意图如明镜般清晰 |
| 8片 | 【太极秘境】开启 | 天地之理，尽在掌握。一道光门缓缓打开...... |

### 属性加成计算
```
总加成 = 各碎片单独加成之和

示例（集齐4片河图）：
- 内功 +2（乾位）
- 体质 +2（坤位）
- 身法 +2（坎位）
- 力道 +2（离位）
```

## 与其他系统联动

### 四维人格影响
- **正≥50**：获取【河图·乾位残片】时额外触发【浩然剑意】线索
- **邪≥50**：获取【洛书·天玑碎片】时可选择炼制禁忌毒药
- **狂≥50**：获取【河图·离位残片】时触发与火山守护者的战斗
- **狷≥50**：可提前感知碎片陷阱，避免触发守护机制

### 初始地联动
若主角选择特定出生地（如圣堂石窟）：
- 获取对应区域碎片时，额外获得【区域记忆残章】
- 集齐全部碎片后，解锁基于出生地的【专属结局线】

## 触发流程

```
1. 主角进入碎片所在区域
   ↓
2. 检查前置条件是否满足
   ↓
3. 若满足，触发碎片发现叙事
   ↓
4. 更新 character_sheet.md（添加碎片到背包、更新属性）
   ↓
5. 更新本文件的收集状态
   ↓
6. 检查是否触发叠加效果
   ↓
7. 生成下一碎片线索提示
```
